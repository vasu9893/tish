<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Subscription Diagnostic</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; width: 300px; }
        .checklist { list-style: none; padding: 0; }
        .checklist li { padding: 8px; margin: 5px 0; border-radius: 3px; }
        .checklist li.pass { background-color: #d4edda; border-left: 4px solid #28a745; }
        .checklist li.fail { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        .checklist li.warning { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        .field-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0; }
        .field-item { padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa; }
        .field-item.required { border-color: #dc3545; background-color: #f8d7da; }
        .field-item.subscribed { border-color: #28a745; background-color: #d4edda; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Webhook Subscription Diagnostic</h1>
        <p>This tool helps diagnose why webhooks are not being sent when someone comments on your Instagram posts.</p>

        <div class="section warning">
            <h3>üö® Current Issue</h3>
            <p><strong>Problem:</strong> No webhook events are being sent when someone comments on your Instagram posts</p>
            <p><strong>Expected Behavior:</strong> When someone comments, you should receive a webhook event in your dashboard</p>
        </div>

        <div class="section">
            <h3>üîë Authentication</h3>
            <input type="text" id="tokenInput" placeholder="Paste your JWT token here..." style="width: 100%; margin-bottom: 10px;" />
            <button onclick="runFullDiagnostic()">Run Full Diagnostic</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'https://tish-production.up.railway.app';
        
        async function runFullDiagnostic() {
            const token = document.getElementById('tokenInput').value.trim();
            const resultsDiv = document.getElementById('results');
            
            if (!token) {
                showResult('error', 'Please enter a JWT token to run the diagnostic');
                return;
            }

            resultsDiv.innerHTML = '';
            showResult('info', 'üîç Running comprehensive webhook diagnostic...');

            const checks = [
                { name: 'Server Health', fn: checkServerHealth },
                { name: 'Instagram Connection', fn: () => checkInstagramConnection(token) },
                { name: 'Webhook Events', fn: () => checkWebhookEvents(token) },
                { name: 'Webhook Subscriptions', fn: () => checkWebhookSubscriptions(token) },
                { name: 'Webhook Endpoint', fn: checkWebhookEndpoint }
            ];

            for (const check of checks) {
                try {
                    showResult('info', `üîç Checking: ${check.name}...`);
                    await check.fn();
                } catch (error) {
                    showResult('error', `‚ùå ${check.name} Failed`, error.message);
                }
            }

            showResult('info', '‚úÖ Diagnostic complete! Review the results above.');
        }

        async function checkServerHealth() {
            try {
                const response = await fetch(`${API_BASE}/api/webhooks/health`);
                const data = await response.json();
                
                if (response.ok && data.status === 'healthy') {
                    showResult('success', '‚úÖ Server Health Check', {
                        status: data.status,
                        uptime: data.uptime,
                        database: data.checks?.database?.status,
                        processor: data.checks?.processor?.status
                    });
                } else {
                    showResult('error', '‚ùå Server Health Check Failed', data);
                }
            } catch (error) {
                showResult('error', '‚ùå Server Health Check Failed', error.message);
            }
        }

        async function checkInstagramConnection(token) {
            try {
                const response = await fetch(`${API_BASE}/api/instagram/status`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (response.ok) {
                    const isConnected = data.status === 'active';
                    showResult(isConnected ? 'success' : 'warning', 
                        isConnected ? '‚úÖ Instagram Connection Active' : '‚ö†Ô∏è Instagram Connection Issue', 
                        {
                            status: data.status,
                            message: data.message,
                            webhookUrl: data.webhookUrl,
                            stats: data.stats
                        });
                } else {
                    showResult('error', '‚ùå Instagram Connection Check Failed', data);
                }
            } catch (error) {
                showResult('error', '‚ùå Instagram Connection Check Failed', error.message);
            }
        }

        async function checkWebhookEvents(token) {
            try {
                const response = await fetch(`${API_BASE}/api/webhooks/events`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (response.ok) {
                    const hasEvents = (data.data?.events?.length || 0) > 0;
                    showResult(hasEvents ? 'success' : 'warning', 
                        hasEvents ? '‚úÖ Webhook Events Found' : '‚ö†Ô∏è No Webhook Events Found', 
                        {
                            totalEvents: data.data?.total || 0,
                            recentEvents: data.data?.events?.length || 0,
                            hasEvents: hasEvents,
                            suggestion: hasEvents ? 'Webhooks are working!' : 'No webhook events received yet. Check subscription configuration.'
                        });
                } else {
                    showResult('error', '‚ùå Webhook Events Check Failed', data);
                }
            } catch (error) {
                showResult('error', '‚ùå Webhook Events Check Failed', error.message);
            }
        }

        async function checkWebhookSubscriptions(token) {
            try {
                const response = await fetch(`${API_BASE}/api/webhooks/subscriptions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (response.ok) {
                    const hasSubscriptions = (data.data?.length || 0) > 0;
                    showResult(hasSubscriptions ? 'success' : 'warning', 
                        hasSubscriptions ? '‚úÖ Webhook Subscriptions Found' : '‚ö†Ô∏è No Webhook Subscriptions Found', 
                        {
                            subscriptionCount: data.data?.length || 0,
                            subscriptions: data.data || [],
                            suggestion: hasSubscriptions ? 'Subscriptions are configured' : 'No webhook subscriptions found. You need to connect Instagram.'
                        });
                } else {
                    showResult('error', '‚ùå Webhook Subscriptions Check Failed', data);
                }
            } catch (error) {
                showResult('error', '‚ùå Webhook Subscriptions Check Failed', error.message);
            }
        }

        async function checkWebhookEndpoint() {
            try {
                const verifyUrl = `${API_BASE}/api/webhooks/instagram?hub.mode=subscribe&hub.verify_token=instantchat_webhook_2024_secure_token&hub.challenge=test123`;
                const response = await fetch(verifyUrl);
                const text = await response.text();
                
                if (response.ok && text === 'test123') {
                    showResult('success', '‚úÖ Webhook Endpoint Accessible', {
                        endpoint: `${API_BASE}/api/webhooks/instagram`,
                        verification: 'Working',
                        challenge: text
                    });
                } else {
                    showResult('error', '‚ùå Webhook Endpoint Not Accessible', {
                        endpoint: `${API_BASE}/api/webhooks/instagram`,
                        status: response.status,
                        response: text
                    });
                }
            } catch (error) {
                showResult('error', '‚ùå Webhook Endpoint Check Failed', error.message);
            }
        }

        function showResult(type, title, data = null) {
            const resultsDiv = document.getElementById('results');
            const section = document.createElement('div');
            section.className = `section ${type}`;
            
            let content = `<h3>${title}</h3>`;
            if (data) {
                content += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            section.innerHTML = content;
            resultsDiv.appendChild(section);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Auto-fill token from localStorage if available
        window.onload = function() {
            const savedToken = localStorage.getItem('token');
            if (savedToken) {
                document.getElementById('tokenInput').value = savedToken;
            }
        };
    </script>
</body>
</html>
